---
import { commentConfig } from "@/config";


// ...其他的导入


interface Props {
	path: string;
}

const config = {
	...commentConfig.twikoo,
	el: "#tcomment",
	path: Astro.props.path,
};
---


<div id="tcomment">
  
</div>
<script is:inline src="/scroll-protection.js"></script>
<script is:inline src="/assets/js/twikoo.all.min.js"></script>
<script is:inline define:vars={{ config }}>
  // 获取当前页面路径
  function getCurrentPath() {
    const pathname = window.location.pathname;
    return pathname.endsWith('/') && pathname.length > 1 ? pathname.slice(0, -1) : pathname;
  }
  
  // 动态创建配置对象
  function createTwikooConfig() {
    return {
      ...config,
      path: getCurrentPath(),
      el: '#tcomment'
    };
  }
  
  // 初始化 Twikoo（幂等处理：每次重建容器内容）
  function initTwikoo() {
    if (typeof twikoo !== 'undefined') {
      const commentEl = document.getElementById('tcomment');
      if (commentEl) {
        commentEl.innerHTML = '';
        const dynamicConfig = createTwikooConfig();
        twikoo.init(dynamicConfig).catch((error) => {
          console.error('[Twikoo] 初始化失败:', error);
        });
      }
    } else {
      // 如果 Twikoo 未加载，稍后重试
      setTimeout(initTwikoo, 300);
    }
  }
  
  // 页面加载时初始化（支持首屏与二次进入）
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => setTimeout(initTwikoo, 100));
  } else {
    setTimeout(initTwikoo, 100);
  }
  
  // Swup 页面切换后重新初始化
  if (window.swup && window.swup.hooks) {
    window.swup.hooks.on('content:replace', function() {
      setTimeout(initTwikoo, 200);
    });
    window.swup.hooks.on('page:view', function() {
      setTimeout(initTwikoo, 300);
    });
  } else {
    document.addEventListener('swup:enable', function() {
      if (window.swup && window.swup.hooks) {
        window.swup.hooks.on('content:replace', function() {
          setTimeout(initTwikoo, 200);
        });
        window.swup.hooks.on('page:view', function() {
          setTimeout(initTwikoo, 300);
        });
      }
    });
  }
  
  // 自定义事件监听（由 Layout 通知）
  document.addEventListener('mizuki:page:loaded', function() {
    if (document.getElementById('tcomment')) {
      setTimeout(initTwikoo, 150);
    }
  });
  
  // bfcache 恢复（前进/后退）触发重建
  window.addEventListener('pageshow', function() {
    if (document.getElementById('tcomment')) {
      setTimeout(initTwikoo, 150);
    }
  });
</script>