---
// src/components/widget/VisitCounter.astro
import { umamiConfig } from "../../config";

// 从配置中提取 apiKey、baseUrl 和网站 ID
const apiKey = umamiConfig.apiKey;
const baseUrl = umamiConfig.baseUrl;
const websiteId = umamiConfig.scripts.match(/data-website-id="([^"]+)"/)?.[1];
---

{umamiConfig.enabled && (
  <div class="text-sm text-gray-500 mt-2 text-center">
    站点总浏览量：<span id="visit-count-display">加载中...</span>
  </div>
)}

{umamiConfig.enabled && (
  <script define:vars={{ baseUrl, apiKey, websiteId }}>
    async function updateVisitCount() {
      try {
        const stats = await getUmamiWebsiteStats(baseUrl, apiKey, websiteId);
        const total = (stats?.pageviews || 0);
        const el = document.getElementById('visit-count-display');
        if (el) el.textContent = String(total);
      } catch (e) {
        const el = document.getElementById('visit-count-display');
        if (el) el.textContent = '不可用';
      }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateVisitCount);
    } else {
      updateVisitCount();
    }
  </script>
)}
---